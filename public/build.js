function p(a){if(!a||-1==a.search(/\n|\r/))return a;var b=function(a,b,c){return a.replace(new RegExp(b,"g"),c)},c=function(c,d){return a=b(a,c,d)},d="(table|thead|tfoot|caption|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select";return d+="|form|blockquote|address|math|style|script|object|input|param|p|h[1-6])",a+="\n",c("<br />\\s*<br />","\n\n"),c("(<"+d+"[^>]*>)","\n$1"),c("(</"+d+">)","$1\n\n"),c("\r\n|\r","\n"),c("\n\n+","\n\n"),c("\n?((.|\n)+?)\n\\s*\n","<p>$1</p>\n"),c("\n?((.|\n)+?)$","<p>$1</p>\n"),c("<p>\\s*?</p>",""),c("<p>(<div[^>]*>\\s*)","$1<p>"),c("<p>([^<]+)\\s*?(</(div|address|form)[^>]*>)","<p>$1</p>$2"),c("<p>\\s*(</?"+d+"[^>]*>)\\s*</p>","$1"),c("<p>(<li.+?)</p>","$1"),c("<p><blockquote([^>]*)>","<blockquote$1><p>"),c("</blockquote></p>","</p></blockquote>"),c("<p>\\s*(</?"+d+"[^>]*>)","$1"),c("(</?"+d+"[^>]*>)\\s*</p>","$1"),c("<(script|style)(.|\n)*?</\\1>",function(a){return b(a,"\n","<PNL>")}),c("(<br />)?\\s*\n","<br />\n"),c("<PNL>","\n"),c("(</?"+d+"[^>]*>)\\s*<br />","$1"),c("<br />(\\s*</?(p|li|div|dl|dd|dt|th|pre|td|ul|ol)[^>]*>)","$1"),-1!=a.indexOf("<pre")&&c("(<pre(.|\n)*?>)((.|\n)*?)</pre>",function(a,c,d,e){return b(c,"\\\\(['\"\\\\])","$1")+b(b(b(e,"<p>","\n"),"</p>|<br />",""),"\\\\(['\"\\\\])","$1")+"</pre>"}),c("\n</p>$","</p>")}function replaceURLWithHTMLLinks(a){var b=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi;return a.replace(b,"<a href='$1'>$1</a>")}angular.module("LJ",["infinite-scroll"]);var scroll={_last:{},save:function(a){this._last[a.url()]=$(document).scrollTop(),console.log(this._last)},restore:function(a){$(document).scrollTop(this._last[a.url()]),console.log("restoring")}};angular.module("LJ").factory("nowTime",["$timeout",function(a){var b;return function c(){b=Date.now(),a(c,1e3)}(),function(){return b}}]),angular.module("LJ").filter("timeAgo",["nowTime",function(a){return function(b){return moment(1e3*b).from(a())}}]),angular.module("LJ").controller("Entry",["$scope","$route","$routeParams","$http","historyFactory","Text",function(a,b,c,d,e,f){d.get("/api/post",{params:{user:c.user,post_id:c.post_id,body:!0}}).success(function(b){console.log(b),a.post_id=Number(c.post_id),a.body=f.prettify(b.event),a.title=b.subject,a.user=c.user,b.user=c.user,b.visited=Date.now(),e.add(b)}),a.$on("$viewContentLoaded",function(){$(document).scrollTop(0)})}]),angular.module("LJ").controller("Feed",["$scope","$http","$timeout","$location","Text",function(a,b,c,d,e){a.feed=[],a.loadMore=function(d){a.busy||(a.busy=!0,b.get("/api/feed",{params:{skip:a.feed.length,itemshow:7}}).success(function(b){console.log(b.entries.length),b.entries.forEach(function(a){a.body=e.prettify(a.body),a.loadComments=!1}),a.feed=a.feed.concat(b.entries),c(function(){a.busy=!1},100),"function"==typeof d&&d()}))},a.go=function(a){scroll.save(d),d.path("/read/"+a)},a.loadMore(function(){c(function(){scroll.restore(d)},0)})}]),angular.module("LJ").factory("historyFactory",function(){function a(){localStorage.setItem("history",JSON.stringify(b.history))}var b={};return b.history=JSON.parse(localStorage.getItem("history"))||[],b.add=function(c){b.history.unshift(c),a()},b.toggleFavorite=function(b){b.favorite=!b.favorite,a()},b.settings={showFavorites:!0},b}),angular.module("LJ").controller("History",["$scope","historyFactory",function(a,b){a.history=b.history,a.toggleFavorite=b.toggleFavorite,a.settings=b.settings,a.filtered=function(){return b.history.filter(function(b){return a.settings.showFavorites?b.favorite:!0})}}]),angular.module("LJ").controller("Journal",["$scope","$http","$route","$routeParams","$location","Text",function(a,b,c,d,e,f){b.get("/api/journal",{params:{user:d.user}}).success(function(b){b.events.forEach(function(a){a.body=f.prettify(a.body)}),a.journal=b.events,console.log(b)})}]),angular.module("LJ").controller("Post",["$scope","$http","$route","$location",function(a,b,c,d){a.load=function(){scroll.save(d),d.path("/read/"+a.post.ljuser[0].journal+"/"+a.post.post_id)}}]),angular.module("LJ").controller("Rating",["$scope","$http","$route","$timeout","$location","ratingFactory",function(a,b,c,d,e,f){a.loading=!0,f.get(function(b){a.rating=b}),a.$on("$viewContentLoaded",function(){d(function(){scroll.restore(e)},0)})}]),angular.module("LJ").directive("blink",["$http",function(a){return{templateUrl:"/partials/comments.html",scope:{postId:"=",user:"="},link:function(b){b.loading=!1,b.page=1,b.page_size=15,b.comments=[],b.hasMore=function(){return b.page<b.pages},b.load=function(){a.get("/api/comments/",{params:{user:b.user,post_id:b.postId,page_size:b.page_size,page:b.page}}).success(function(a){console.log(a),b.comments=b.comments.concat(a.comments),b.pages=a.pages,b.loading=!1})},b.loadMore=function(){b.page+=1,b.load()},b.isAuthor=function(a){return a.postername===b.user},b.$watch("postId",function(){b.user&&b.postId&&(b.loading=!0,console.log("LOADING"),b.load())})}}}]),angular.module("LJ").factory("ratingFactory",["$http",function(a){var b={},c=null;return b.get=function(b){if(c)return b(c),void 0;var d="http://l-api.livejournal.com/__api/?request=",e={jsonrpc:"2.0",method:"homepage.get_rating",params:{homepage:1,sort:"visitors",page:0,country:"cyr",locale:"ru_RU",category_id:0},id:Date.now()};a.jsonp(d+encodeURIComponent(JSON.stringify(e)),{params:{callback:"JSON_CALLBACK"}}).success(function(a){a.result||console.error(a),c=a.result.rating.slice(0,150),b(c)})},b}]),angular.module("LJ").filter("prettify",["Text",function(a){return function(b){return a.prettify(b)}}]),angular.module("LJ").factory("Text",["$filter",function(){function a(a){a=a.replace('<a name="Read more..."></a>',"");var b=$.parseHTML("<div>"+a+"</div>"),c=$(b);return c.find('[source="youtube"]').each(function(a,b){var c=$(b);c.replaceWith('<div class="b-embed"><iframe type="text/html" src="http://www.youtube.com/embed/'+c.attr("vid")+'" frameborder="0"/></div>')}),c.find('a[name="Read more..."]').remove(),c.find("center, u, font").each(function(a,b){var c=$(b);c.replaceWith(c.children())}),c.find("*[style]").removeAttr("style"),c.find('a[href*="add.bml"]').remove(),c.find("p").filter(function(){return""===$.trim($(this).text())&&0==$(this).children().length}).remove(),c.find("br").each(function(a,b){var c=$(b),d=c.get(0).nextSibling;if($(d).is("br"))for(;d=d.nextSibling;)$(d).is("br")&&$(d).remove()}),c.html()}function b(a){var b=/[^\"]((https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi;return a.replace(b," <a href='$1'>$1</a>")}var c={};return c.prettify=function(c){return a(p(b(c)))},c}]),angular.module("LJ").config(["$routeProvider","$locationProvider",function(a,b){b.html5Mode(!0),a.when("/",{templateUrl:"/partials/rating.html",controller:"Rating",reloadOnSearch:!1}).when("/read/:user/:post_id",{templateUrl:"/partials/post.html",controller:"Entry"}).when("/read/:user",{templateUrl:"/partials/journal.html",controller:"Journal"}).when("/feed",{templateUrl:"/partials/feed.html",controller:"Feed"}).when("/comments",{templateUrl:"/partials/test.html",controller:"Comments"}).when("/history",{templateUrl:"/partials/history.html",controller:"History"})}]);var mod;mod=angular.module("infinite-scroll",[]),mod.directive("infiniteScroll",["$rootScope","$window","$timeout",function(a,b,c){return{link:function(d,e,f){var g,h,i,j;return b=angular.element(b),i=0,null!=f.infiniteScrollDistance&&d.$watch(f.infiniteScrollDistance,function(a){return i=parseInt(a,10)}),j=!0,g=!1,null!=f.infiniteScrollDisabled&&d.$watch(f.infiniteScrollDisabled,function(a){return j=!a,j&&g?(g=!1,h()):void 0}),h=function(){var c,h,k,l;return l=b.height()+b.scrollTop(),c=e.offset().top+e.height(),h=c-l,k=h<=b.height()*i,k&&j?a.$$phase?d.$eval(f.infiniteScroll):d.$apply(f.infiniteScroll):k?g=!0:void 0},b.on("scroll",h),d.$on("$destroy",function(){return b.off("scroll",h)}),c(function(){return f.infiniteScrollImmediateCheck?d.$eval(f.infiniteScrollImmediateCheck)?h():void 0:h()},0)}}}]);